<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试报告可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            background-color: #fff;
            color: #333;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
            max-width: 100%;
        }
        .left-panel {
            width: 33.33%;
            min-width: 33.33%;
            max-width: 33.33%;
            display: flex;
            flex-direction: column;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
        }
        .right-panel {
            width: 66.67%;
            min-width: 66.67%;
            max-width: 66.67%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .stat-box.total {
            background-color: #3498db;
        }
        .stat-box.success {
            background-color: #2ecc71;
        }
        .stat-box.failed {
            background-color: #e74c3c;
        }
        .stat-box h3 {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .stat-box p {
            font-size: 24px;
            font-weight: bold;
        }
        .cases-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        .chart-container {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        .chart-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .chart-button {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f8f8;
            cursor: pointer;
        }
        .chart-button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .bottom-charts {
            display: flex;
            gap: 20px;
            flex: 1;
        }
        .donut-chart-container {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        .bar-chart-container {
            flex: 2;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        .scene-item {
            margin-bottom: 10px;
            cursor: pointer;
        }
        .scene-name {
            padding: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .scene-name.success {
            background-color: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
        }
        .scene-name.failed {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
        }
        .scene-name.skipped {
            background-color: rgba(241, 196, 15, 0.1);
            border-left: 4px solid #f1c40f;
        }
        .steps-container {
            margin-left: 20px;
            display: none;
        }
        .step-item {
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .step-item.success {
            background-color: rgba(46, 204, 113, 0.05);
            border-left: 2px solid #2ecc71;
        }
        .step-item.failed {
            background-color: rgba(231, 76, 60, 0.05);
            border-left: 2px solid #e74c3c;
        }
        .step-item.skipped {
            background-color: rgba(241, 196, 15, 0.05);
            border-left: 2px solid #f1c40f;
        }
        .step-item.skipped {
            background-color: rgba(241, 196, 15, 0.05);
            border-left: 2px solid #f1c40f;
        }
        .step-details {
            margin-left: 20px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-top: 5px;
            display: none;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .step-details-content {
            display: flex;
            gap: 20px;
        }
        .step-details-request,
        .step-details-response {
            flex: 1;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .toggle-icon {
            margin-left: auto;
            font-size: 12px;
            display: none; /* 隐藏加号图标 */
        }
        .duration-badge {
            margin-left: auto;
            background-color: #555;
            color: white;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            min-width: 50px;
            text-align: center;
            display: inline-block;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.success {
            background-color: #2ecc71;
        }
        .status-indicator.failed {
            background-color: #e74c3c;
        }
        .status-indicator.skipped {
            background-color: #f1c40f;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 8px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.success {
            background-color: #2ecc71;
        }
        .status-badge.failed {
            background-color: #e74c3c;
        }
        .status-badge.skipped {
            background-color: #f1c40f;
        }
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 8px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .type-badge.scene {
            background-color: #3498db;
        }
        .type-badge.step {
            background-color: #9b59b6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="stats-container">
                <div class="stat-box total">
                    <h3>总用例数</h3>
                    <p id="total-count">0</p>
                </div>
                <div class="stat-box success">
                    <h3>成功用例数</h3>
                    <p id="success-count">0</p>
                </div>
                <div class="stat-box failed">
                    <h3>失败用例数</h3>
                    <p id="failed-count">0</p>
                </div>
            </div>
            <div class="cases-container" id="cases-container">
                <!-- 测试用例层级列表将在这里动态生成 -->
            </div>
        </div>
        <div class="right-panel">
            <div class="chart-container">
                <div class="chart-buttons">
                    <button class="chart-button active" id="pass-rate-btn">通过率</button>
                    <button class="chart-button" id="case-count-btn">用例数量</button>
                    <button class="chart-button" id="current-data-btn" style="display: none; background-color: #e67e22; color: white; border-color: #e67e22;">返回当前数据</button>
                </div>
                <canvas id="line-chart"></canvas>
            </div>
            <div class="bottom-charts">
                <div class="donut-chart-container">
                    <canvas id="donut-chart"></canvas>
                </div>
                <div class="bar-chart-container">
                    <canvas id="bar-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量，用于存储当前数据和历史数据
        let currentData = null;
        let currentHistoryData = null;
        let currentChartType = 'pass-rate';
        let isViewingHistory = false;
        
        // 初始化Socket.IO连接
        const socket = io();
        
        // 监听文件变化事件
        socket.on('files_changed', function(data) {
            console.log('检测到文件变化:', data);
            
            // 如果用户正在查看历史数据，不自动刷新
            if (isViewingHistory) {
                return;
            }
            
            // 根据变化类型刷新数据
            if (data.type === 'result') {
                console.log('刷新当前结果数据');
                refreshCurrentData();
            } else if (data.type === 'history') {
                console.log('刷新历史数据');
                refreshHistoryData();
            }
        });
        
        // 刷新当前结果数据
        function refreshCurrentData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    // 更新全局数据
                    currentData = data;
                    
                    // 更新统计数据
                    updateStats(data.current);
                    
                    // 渲染测试用例层级列表
                    renderCasesList(data.current.scenes);
                    
                    // 渲染环形图和柱状图
                    renderDonutChart(data.current);
                    renderBarChart(data.current.step_failures);
                    
                    console.log('当前数据已刷新');
                })
                .catch(error => {
                    console.error('刷新当前数据出错:', error);
                });
        }
        
        // 刷新历史数据
        function refreshHistoryData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    // 更新全局历史数据
                    currentHistoryData = data.history;
                    
                    // 重新渲染折线图
                    renderLineChart(data.history, currentChartType);
                    
                    console.log('历史数据已刷新');
                })
                .catch(error => {
                    console.error('刷新历史数据出错:', error);
                });
        }
        
        // 获取数据
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                // 保存当前数据
                currentData = data;
                currentHistoryData = data.history;
                
                // 更新统计数据
                updateStats(data.current);
                
                // 渲染测试用例层级列表
                renderCasesList(data.current.scenes);
                
                // 渲染图表
                renderLineChart(data.history, 'pass-rate');
                renderDonutChart(data.current);
                renderBarChart(data.current.step_failures);

                // 定义全局筛选函数和状态
                let currentFilter = null;
                let currentStepFilter = null;
                // 将筛选函数定义为全局函数，以便在环形图点击事件中使用
                window.filterCases = (status) => {
                    // 清除步骤筛选状态
                    currentStepFilter = null;
                    
                    // 清除失败步骤筛选提示
                    const existingFilter = document.getElementById('filter-notice');
                    if (existingFilter) {
                        const casesContainer = document.getElementById('cases-container');
                        casesContainer.removeChild(existingFilter);
                    }
                    
                    const scenes = document.querySelectorAll('.scene-item');
                    scenes.forEach(scene => {
                        const sceneStatus = scene.querySelector('.scene-name').classList.contains('success') ? 1 :
                                      scene.querySelector('.scene-name').classList.contains('skipped') ? 2 : 0;
                        scene.style.display = status === null || sceneStatus === status ? 'block' : 'none';
                    });
                };

                document.querySelector('.stat-box.total').addEventListener('click', () => {
                    window.currentFilter = null;
                    window.filterCases(null);
                    document.querySelectorAll('.stat-box').forEach(box => box.style.opacity = '1');
                    
                    // 清除失败步骤筛选提示
                    const existingFilter = document.getElementById('filter-notice');
                    if (existingFilter) {
                        const casesContainer = document.getElementById('cases-container');
                        casesContainer.removeChild(existingFilter);
                    }
                    
                    // 重置步骤筛选状态
                    currentStepFilter = null;
                });

                document.querySelector('.stat-box.success').addEventListener('click', () => {
                    window.currentFilter = 1;
                    window.filterCases(1);
                    document.querySelectorAll('.stat-box').forEach(box => box.style.opacity = '0.5');
                    document.querySelector('.stat-box.success').style.opacity = '1';
                    
                    // 清除失败步骤筛选提示
                    const existingFilter = document.getElementById('filter-notice');
                    if (existingFilter) {
                        const casesContainer = document.getElementById('cases-container');
                        casesContainer.removeChild(existingFilter);
                    }
                    
                    // 重置步骤筛选状态
                    currentStepFilter = null;
                });

                document.querySelector('.stat-box.failed').addEventListener('click', () => {
                    window.currentFilter = 0;
                    window.filterCases(0);
                    document.querySelectorAll('.stat-box').forEach(box => box.style.opacity = '0.5');
                    document.querySelector('.stat-box.failed').style.opacity = '1';
                    
                    // 清除失败步骤筛选提示
                    const existingFilter = document.getElementById('filter-notice');
                    if (existingFilter) {
                        const casesContainer = document.getElementById('cases-container');
                        casesContainer.removeChild(existingFilter);
                    }
                    
                    // 重置步骤筛选状态
                    currentStepFilter = null;
                });
                
                // 添加图表切换按钮事件
                document.getElementById('pass-rate-btn').addEventListener('click', function() {
                    document.getElementById('pass-rate-btn').classList.add('active');
                    document.getElementById('case-count-btn').classList.remove('active');
                    renderLineChart(currentHistoryData, 'pass-rate');
                });
                
                document.getElementById('case-count-btn').addEventListener('click', function() {
                    document.getElementById('case-count-btn').classList.add('active');
                    document.getElementById('pass-rate-btn').classList.remove('active');
                    renderLineChart(currentHistoryData, 'case-count');
                });
                
                // 添加返回当前数据按钮事件
                document.getElementById('current-data-btn').addEventListener('click', function() {
                    loadCurrentData();
                });
            });
        
        // 加载历史数据
        function loadHistoryData(date) {
            // 显示加载中状态
            document.getElementById('cases-container').innerHTML = '<div style="text-align: center; padding: 20px;">加载中...</div>';
            
            // 显示返回当前数据按钮
            document.getElementById('current-data-btn').style.display = 'block';
            
            // 设置查看历史数据状态
            isViewingHistory = true;
            
            // 获取历史数据
            fetch(`/api/history/${encodeURIComponent(date)}`)
                .then(response => response.json())
                .then(data => {
                    // 更新统计数据
                    updateStats(data);
                    
                    // 渲染测试用例层级列表
                    renderCasesList(data.scenes);
                    
                    // 渲染环形图和柱状图
                    renderDonutChart(data);
                    renderBarChart(data.step_failures);
                    
                    // 添加历史数据标记
                    const title = document.createElement('div');
                    title.style.textAlign = 'center';
                    title.style.padding = '10px';
                    title.style.backgroundColor = '#f39c12';
                    title.style.color = 'white';
                    title.style.borderRadius = '4px';
                    title.style.marginBottom = '10px';
                    title.style.fontWeight = 'bold';
                    title.innerHTML = `查看历史数据: ${date}`;
                    document.getElementById('cases-container').insertBefore(title, document.getElementById('cases-container').firstChild);
                })
                .catch(error => {
                    console.error('Error loading history data:', error);
                    document.getElementById('cases-container').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">加载历史数据失败</div>';
                });
        }
        
        // 加载当前数据
        function loadCurrentData() {
            if (!isViewingHistory) return;
            
            // 隐藏返回当前数据按钮
            document.getElementById('current-data-btn').style.display = 'none';
            
            // 重置查看历史数据状态
            isViewingHistory = false;
            
            // 更新统计数据
            updateStats(currentData.current);
            
            // 渲染测试用例层级列表
            renderCasesList(currentData.current.scenes);
            
            // 渲染环形图和柱状图
            renderDonutChart(currentData.current);
            renderBarChart(currentData.current.step_failures);
        }
        
        // 更新统计数据
        function updateStats(data) {
            document.getElementById('total-count').textContent = data.total;
            document.getElementById('success-count').textContent = data.success;
            document.getElementById('failed-count').textContent = data.failed;
        }
        
        // 渲染测试用例层级列表
        function renderCasesList(scenes) {
            const container = document.getElementById('cases-container');
            container.innerHTML = '';
            
            scenes.forEach((scene, index) => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'scene-item';
                
                const sceneName = document.createElement('div');
                const statusClass = scene.is_success === 1 ? 'success' : (scene.is_success === 2 ? 'skipped' : 'failed');
                sceneName.className = `scene-name ${statusClass}`;
                
                const statusBadge = document.createElement('span');
                statusBadge.className = `status-badge ${statusClass}`;
                statusBadge.textContent = scene.is_success === 1 ? '成功' : (scene.is_success === 2 ? '跳过' : '失败');
                
                const nameSpan = document.createElement('span');
                // 使用scene_name或step_name作为场景名称，如果都不存在则使用默认名称
                nameSpan.textContent = scene.scene_name || scene.step_name || `场景 ${index + 1}`;
                
                const toggleIcon = document.createElement('span');
                toggleIcon.className = 'toggle-icon';
                toggleIcon.textContent = '+';
                
                const sceneDurationSpan = document.createElement('span');
                sceneDurationSpan.className = 'duration-badge';
                // 计算场景总运行时间
                let totalDuration = 0;
                if (scene.scene_result && Array.isArray(scene.scene_result)) {
                    scene.scene_result.forEach(step => {
                        totalDuration += (step.duration || 0);
                    });
                } else {
                    // 如果没有子步骤，使用自身的duration
                    totalDuration = scene.duration || 0;
                }
                sceneDurationSpan.textContent = `${totalDuration}s`;
                
                sceneName.appendChild(statusBadge);
                sceneName.appendChild(nameSpan);
                sceneName.appendChild(toggleIcon);
                sceneName.appendChild(sceneDurationSpan);
                
                const stepsContainer = document.createElement('div');
                stepsContainer.className = 'steps-container';
                
                // 递归处理嵌套场景和步骤
                if (scene.scene_result && Array.isArray(scene.scene_result)) {
                    renderSteps(scene.scene_result, stepsContainer);
                }
                
                sceneName.addEventListener('click', function() {
                    if (stepsContainer.style.display === 'block') {
                        stepsContainer.style.display = 'none';
                        toggleIcon.textContent = '+';
                    } else {
                        stepsContainer.style.display = 'block';
                        toggleIcon.textContent = '-';
                    }
                });
                
                sceneItem.appendChild(sceneName);
                sceneItem.appendChild(stepsContainer);
                container.appendChild(sceneItem);
            });
        }
        
        // 递归渲染步骤和嵌套场景
        function renderSteps(steps, container) {
            steps.forEach((step, stepIndex) => {
                // 检查是否为嵌套场景（具有scene_name或包含scene_result数组）
                const isNestedScene = step.scene_name || (step.scene_result && Array.isArray(step.scene_result) && step.scene_result.length > 0);
                
                const stepItem = document.createElement('div');
                const stepStatusClass = step.is_success === 1 ? 'success' : (step.is_success === 2 ? 'skipped' : 'failed');
                stepItem.className = isNestedScene ? 'scene-item' : `step-item ${stepStatusClass}`;
                
                if (isNestedScene) {
                    // 处理嵌套场景
                    const nestedSceneName = document.createElement('div');
                    nestedSceneName.className = `scene-name ${stepStatusClass}`;
                    
                    const nestedStatusBadge = document.createElement('span');
                    nestedStatusBadge.className = `status-badge ${stepStatusClass}`;
                    nestedStatusBadge.textContent = step.is_success === 1 ? '成功' : (step.is_success === 2 ? '跳过' : '失败');
                    
                    const nestedTypeBadge = document.createElement('span');
                    nestedTypeBadge.className = 'type-badge scene';
                    nestedTypeBadge.textContent = '场景';
                    
                    const nestedNameSpan = document.createElement('span');
                    nestedNameSpan.textContent = step.scene_name || step.step_name || `嵌套场景 ${stepIndex + 1}`;
                    
                    const nestedToggleIcon = document.createElement('span');
                    nestedToggleIcon.className = 'toggle-icon';
                    nestedToggleIcon.textContent = '+';
                    
                    const nestedDurationSpan = document.createElement('span');
                    nestedDurationSpan.className = 'duration-badge';
                    let nestedTotalDuration = 0;
                    if (step.scene_result && Array.isArray(step.scene_result)) {
                        step.scene_result.forEach(subStep => {
                            nestedTotalDuration += (subStep.duration || 0);
                        });
                    } else {
                        nestedTotalDuration = step.duration || 0;
                    }
                    nestedDurationSpan.textContent = `${nestedTotalDuration}s`;
                    
                    nestedSceneName.appendChild(nestedStatusBadge);
                    nestedSceneName.appendChild(nestedTypeBadge);
                    nestedSceneName.appendChild(nestedNameSpan);
                    nestedSceneName.appendChild(nestedToggleIcon);
                    nestedSceneName.appendChild(nestedDurationSpan);
                    
                    const nestedStepsContainer = document.createElement('div');
                    nestedStepsContainer.className = 'steps-container';
                    
                    if (step.scene_result && Array.isArray(step.scene_result)) {
                        renderSteps(step.scene_result, nestedStepsContainer);
                    }
                    
                    nestedSceneName.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (nestedStepsContainer.style.display === 'block') {
                            nestedStepsContainer.style.display = 'none';
                            nestedToggleIcon.textContent = '+';
                        } else {
                            nestedStepsContainer.style.display = 'block';
                            nestedToggleIcon.textContent = '-';
                        }
                    });
                    
                    stepItem.appendChild(nestedSceneName);
                    stepItem.appendChild(nestedStepsContainer);
                } else {
                    // 处理普通步骤
                    const stepStatusBadge = document.createElement('span');
                    stepStatusBadge.className = `status-badge ${stepStatusClass}`;
                    stepStatusBadge.textContent = step.is_success === 1 ? '成功' : (step.is_success === 2 ? '跳过' : '失败');
                    
                    const stepTypeBadge = document.createElement('span');
                    stepTypeBadge.className = 'type-badge step';
                    stepTypeBadge.textContent = '步骤';
                    
                    const stepNameSpan = document.createElement('span');
                    stepNameSpan.textContent = step.step_name || `步骤 ${stepIndex + 1}`;
                    
                    const stepToggleIcon = document.createElement('span');
                    stepToggleIcon.className = 'toggle-icon';
                    stepToggleIcon.textContent = '+';
                    
                    const stepDurationSpan = document.createElement('span');
                    stepDurationSpan.className = 'duration-badge';
                    stepDurationSpan.textContent = `${step.duration || 0}s`;
            
                    stepItem.appendChild(stepStatusBadge);
                    stepItem.appendChild(stepTypeBadge);
                    stepItem.appendChild(stepNameSpan);
                    stepItem.appendChild(stepToggleIcon);
                    stepItem.appendChild(stepDurationSpan);
                    
                    const stepDetails = document.createElement('div');
                    stepDetails.className = 'step-details';
                    stepDetails.innerHTML = `
                        <div class="step-details-content">
                            <div class="step-details-request">
                                <h4>请求信息</h4>
                                <p><strong>路径:</strong> ${step.path || 'N/A'}</p>
                                <p><strong>方法:</strong> ${step.method || 'N/A'}</p>
                                <p><strong>类型:</strong> ${step.step_type || 'N/A'}</p>
                                ${step.query ? `<p><strong>查询参数:</strong> <pre>${JSON.stringify(step.query, null, 2)}</pre></p>` : ''}
                                ${step.body ? `<p><strong>请求体:</strong> <pre>${JSON.stringify(step.body, null, 2)}</pre></p>` : ''}
                            </div>
                            <div class="step-details-response">
                                <h4>响应信息</h4>
                                ${step.error_msg ? `<p><strong>错误:</strong> ${step.error_msg}</p>` : ''}
                                ${step.response ? `<p><strong>响应:</strong> <pre>${JSON.stringify(step.response, null, 2)}</pre></p>` : ''}
                            </div>
                        </div>
                    `;
                    
                    stepItem.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (stepDetails.style.display === 'block') {
                            stepDetails.style.display = 'none';
                            stepToggleIcon.textContent = '+';
                        } else {
                            stepDetails.style.display = 'block';
                            stepToggleIcon.textContent = '-';
                        }
                    });
                    
                    container.appendChild(stepItem);
                    container.appendChild(stepDetails);
                    return;
                }
                
                container.appendChild(stepItem);
            });
        }
        
        // 渲染折线图
        function renderLineChart(historyData, type) {
            const ctx = document.getElementById('line-chart').getContext('2d');
            
            // 销毁现有图表（如果存在）
            if (window.lineChart) {
                window.lineChart.destroy();
            }
            
            const dates = historyData.map(item => item.date);
            
            if (type === 'pass-rate') {
                const passRates = historyData.map(item => item.pass_rate);
                
                window.lineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: '通过率 (%)',
                            data: passRates.map(rate => parseFloat(rate.toFixed(2))),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '通过率趋势'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `通过率: ${context.raw.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(2) + '%';
                                    }
                                }
                            }
                        },
                        onClick: (event, elements, chart) => {
                            // 获取点击位置的X坐标
                            const canvasPosition = Chart.helpers.getRelativePosition(event, chart.chart);
                            const xIndex = Math.round(chart.scales.x.getValueForPixel(canvasPosition.x));
                            
                            // 确保索引在有效范围内
                            if (xIndex >= 0 && xIndex < dates.length) {
                                const date = dates[xIndex];
                                // 检查是否点击的是最新数据点
                                if (xIndex === dates.length - 1) {
                                    // 如果是最新数据点，则返回当前数据视图
                                    loadCurrentData();
                                } else {
                                    // 否则加载历史数据
                                    loadHistoryData(date);
                                }
                            }
                        }
                    }
                });
            } else if (type === 'case-count') {
                const successCounts = historyData.map(item => item.success);
                const failedCounts = historyData.map(item => item.failed);
                const skippedCounts = historyData.map(item => item.skipped);
                
                window.lineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: '成功用例',
                                data: successCounts,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: '失败用例',
                                data: failedCounts,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: '跳过用例',
                                data: skippedCounts,
                                borderColor: '#f1c40f',
                                backgroundColor: 'rgba(241, 196, 15, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '用例数量趋势'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        onClick: (event, elements, chart) => {
                            // 获取点击位置的X坐标
                            const canvasPosition = Chart.helpers.getRelativePosition(event, chart.chart);
                            const xIndex = Math.round(chart.scales.x.getValueForPixel(canvasPosition.x));
                            
                            // 确保索引在有效范围内
                            if (xIndex >= 0 && xIndex < dates.length) {
                                const date = dates[xIndex];
                                // 检查是否点击的是最新数据点
                                if (xIndex === dates.length - 1) {
                                    // 如果是最新数据点，则返回当前数据视图
                                    loadCurrentData();
                                } else {
                                    // 否则加载历史数据
                                    loadHistoryData(date);
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 加载历史数据
        function loadHistoryData(date) {
            // 显示加载中状态
            document.getElementById('cases-container').innerHTML = '<div style="text-align: center; padding: 20px;">加载中...</div>';
            
            // 显示返回当前数据按钮
            document.getElementById('current-data-btn').style.display = 'block';
            
            // 设置查看历史数据状态
            isViewingHistory = true;
            
            // 获取历史数据
            fetch(`/api/history/${encodeURIComponent(date)}`)
                .then(response => response.json())
                .then(data => {
                    // 更新统计数据
                    updateStats(data);
                    
                    // 渲染测试用例层级列表
                    renderCasesList(data.scenes);
                    
                    // 渲染环形图和柱状图
                    renderDonutChart(data);
                    renderBarChart(data.step_failures);
                    
                    // 添加历史数据标记
                    const title = document.createElement('div');
                    title.style.textAlign = 'center';
                    title.style.padding = '10px';
                    title.style.backgroundColor = '#f39c12';
                    title.style.color = 'white';
                    title.style.borderRadius = '4px';
                    title.style.marginBottom = '10px';
                    title.style.fontWeight = 'bold';
                    title.innerHTML = `查看历史数据: ${date}`;
                    document.getElementById('cases-container').insertBefore(title, document.getElementById('cases-container').firstChild);
                })
                .catch(error => {
                    console.error('Error loading history data:', error);
                    document.getElementById('cases-container').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">加载历史数据失败</div>';
                });
        }
        
        // 加载当前数据
        function loadCurrentData() {
            if (!isViewingHistory) return;
            
            // 隐藏返回当前数据按钮
            document.getElementById('current-data-btn').style.display = 'none';
            
            // 重置查看历史数据状态
            isViewingHistory = false;
            
            // 更新统计数据
            updateStats(currentData.current);
            
            // 渲染测试用例层级列表
            renderCasesList(currentData.current.scenes);
            
            // 渲染环形图和柱状图
            renderDonutChart(currentData.current);
            renderBarChart(currentData.current.step_failures);
        }
        
        // 更新统计数据
        function updateStats(data) {
            document.getElementById('total-count').textContent = data.total;
            document.getElementById('success-count').textContent = data.success;
            document.getElementById('failed-count').textContent = data.failed;
        }
        
        
        // 渲染环形图
        function renderDonutChart(data) {
            const ctx = document.getElementById('donut-chart').getContext('2d');
            
            // 销毁现有图表（如果存在）
            if (window.donutChart) {
                window.donutChart.destroy();
            }
            
            // 计算成功率
            const passRate = (data.success / (data.success + data.failed + data.skipped) * 100).toFixed(1);
            
            window.donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['成功', '失败', '跳过'],
                    datasets: [{
                        data: [data.success, data.failed, data.skipped],
                        backgroundColor: ['#2ecc71', '#e74c3c', '#f1c40f']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '用例执行结果分布'
                        },
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    const labels = ['成功率：', '失败率：', '跳过率：'];
                                    return labels[context.dataIndex] + percentage + '%';
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const status = index === 0 ? 1 : (index === 1 ? 0 : 2);
                            window.currentFilter = status;
                            window.filterCases(status);
                            
                            // 清除失败步骤筛选提示
                            const existingFilter = document.getElementById('filter-notice');
                            if (existingFilter) {
                                const casesContainer = document.getElementById('cases-container');
                                casesContainer.removeChild(existingFilter);
                            }
                            
                            document.querySelectorAll('.stat-box').forEach(box => box.style.opacity = '0.5');
                            const boxClass = status === 1 ? 'success' : (status === 0 ? 'failed' : 'skipped');
                            document.querySelector(`.stat-box.${boxClass}`).style.opacity = '1';
                        } else {
                            window.currentFilter = null;
                            window.filterCases(null);
                            
                            // 清除失败步骤筛选提示
                            const existingFilter = document.getElementById('filter-notice');
                            if (existingFilter) {
                                const casesContainer = document.getElementById('cases-container');
                                casesContainer.removeChild(existingFilter);
                            }
                            
                            document.querySelectorAll('.stat-box').forEach(box => box.style.opacity = '1');
                        }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: function(chart) {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;
                        
                        ctx.restore();
                        ctx.font = 'bold 18px Arial';  // 将字体大小从24px改为18px
                        ctx.textBaseline = 'middle';
                        ctx.textAlign = 'center';
                        
                        // 绘制成功率数值
                        ctx.fillStyle = '#333';
                        ctx.fillText(passRate + '%', width / 2, height / 2);
                        
                        ctx.save();
                    }
                }]
            });
        }
        
        // 渲染条形图
        function renderBarChart(stepFailures) {
            const ctx = document.getElementById('bar-chart').getContext('2d');
            
            // 销毁现有图表（如果存在）
            if (window.barChart) {
                window.barChart.destroy();
            }
            
            const steps = stepFailures.map(item => item.step);
            const failures = stepFailures.map(item => item.failures);
            
            window.barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: steps,
                    datasets: [{
                        label: '失败次数',
                        data: failures,
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `失败次数: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 30 ? label.substr(0, 27) + '...' : label;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const stepName = steps[index];
                            filterScenesByStep(stepName);
                        }
                    }
                }
            });
        }

        function filterScenesByStep(stepName) {
            const scenes = document.querySelectorAll('.scene-item');
            let filteredCount = 0;
            
            // 更新当前筛选状态
            currentStepFilter = stepName;
            
            // 添加筛选提示
            const casesContainer = document.getElementById('cases-container');
            const existingFilter = document.getElementById('filter-notice');
            if (existingFilter) {
                casesContainer.removeChild(existingFilter);
            }
            
            const filterNotice = document.createElement('div');
            filterNotice.id = 'filter-notice';
            filterNotice.style.padding = '8px';
            filterNotice.style.marginBottom = '10px';
            filterNotice.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
            filterNotice.style.borderRadius = '4px';
            filterNotice.style.display = 'flex';
            filterNotice.style.justifyContent = 'space-between';
            filterNotice.style.alignItems = 'center';
            
            const filterText = document.createElement('span');
            filterText.textContent = `当前筛选: 失败步骤 "${stepName}"`;
            filterNotice.appendChild(filterText);
            
            const clearButton = document.createElement('button');
            clearButton.textContent = '清除筛选';
            clearButton.style.padding = '4px 8px';
            clearButton.style.backgroundColor = '#e74c3c';
            clearButton.style.color = 'white';
            clearButton.style.border = 'none';
            clearButton.style.borderRadius = '4px';
            clearButton.style.cursor = 'pointer';
            clearButton.onclick = () => {
                scenes.forEach(scene => scene.style.display = 'block');
                casesContainer.removeChild(filterNotice);
                currentStepFilter = null;
                // 清除所有高亮
                document.querySelectorAll('.step-item').forEach(step => {
                    step.style.backgroundColor = '';
                });
            };
            filterNotice.appendChild(clearButton);
            
            casesContainer.insertBefore(filterNotice, casesContainer.firstChild);
            
            // 筛选场景
            scenes.forEach(scene => {
                let hasFailedStep = false;
                
                // 递归检查所有步骤，包括嵌套的步骤
                function checkSteps(container) {
                    const steps = container.querySelectorAll(':scope > .step-item');
                    steps.forEach(step => {
                        const stepNameElement = step.querySelector('span:nth-child(3)');
                        if (stepNameElement && stepNameElement.textContent === stepName && step.classList.contains('failed')) {
                            hasFailedStep = true;
                            step.style.backgroundColor = 'rgba(231, 76, 60, 0.2)';
                        } else if (step.style.backgroundColor) {
                            step.style.backgroundColor = '';
                        }
                    });
                    
                    // 检查嵌套场景
                    const nestedScenes = container.querySelectorAll(':scope > .scene-item');
                    nestedScenes.forEach(nestedScene => {
                        const stepsContainer = nestedScene.querySelector('.steps-container');
                        if (stepsContainer) {
                            checkSteps(stepsContainer);
                        }
                    });
                }
                
                // 检查当前场景的步骤
                const stepsContainer = scene.querySelector('.steps-container');
                if (stepsContainer) {
                    checkSteps(stepsContainer);
                }
                
                if (hasFailedStep) {
                    scene.style.display = 'block';
                    filteredCount++;
                } else {
                    scene.style.display = 'none';
                }
            });
            
            // 更新筛选提示中的计数
            filterText.textContent = `当前筛选: 失败步骤 "${stepName}" (找到 ${filteredCount} 个场景)`;
        }
    </script>
</body>
</html>